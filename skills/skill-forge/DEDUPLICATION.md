# é¢˜ç›®å»é‡æœºåˆ¶è¯¦è§£

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·æå‡ºï¼šä½¿ç”¨MD5å“ˆå¸Œå»é‡å­˜åœ¨å±€é™æ€§ - é¢˜ç›®ç¨æœ‰å·®å¼‚ï¼ˆå¦‚"ä»€ä¹ˆæ˜¯ReActæ¨¡å¼ï¼Ÿ"å’Œ"ReActæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ"ï¼‰ï¼Œå“ˆå¸Œå€¼ä¼šå®Œå…¨ä¸åŒï¼Œä½†è¿™ä¸¤ä¸ªé¢˜ç›®æœ¬è´¨ç›¸åŒã€‚

## è§£å†³æ–¹æ¡ˆï¼šä¸‰å±‚å»é‡ç­–ç•¥

### ğŸ“Š ç­–ç•¥å¯¹æ¯”

| å±‚çº§ | æ–¹æ³• | é€Ÿåº¦ | å‡†ç¡®åº¦ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|--------|---------|
| ç¬¬ä¸€å±‚ | å†…å®¹å“ˆå¸Œç²¾ç¡®åŒ¹é… | âš¡ æå¿« | 100% | å®Œå…¨ç›¸åŒçš„é¢˜ç›® |
| ç¬¬äºŒå±‚ | æ–‡æœ¬ç›¸ä¼¼åº¦ç®—æ³• | ğŸš€ å¿«é€Ÿ | 85-90% | æªè¾ä¸åŒä½†æ„æ€ç›¸åŒ |
| ç¬¬ä¸‰å±‚ | Claudeè¯­ä¹‰åˆ¤æ–­ | ğŸŒ è¾ƒæ…¢ | 95-99% | ç–‘éš¾è¾¹ç•Œæƒ…å†µ |

### ç¬¬ä¸€å±‚ï¼šå†…å®¹å“ˆå¸Œç²¾ç¡®åŒ¹é…

**åŸç†**ï¼šå¯¹é¢˜ç›®å†…å®¹ + é€‰é¡¹è¿›è¡ŒMD5å“ˆå¸Œï¼Œæ¯”å¯¹å“ˆå¸Œå€¼

**ä¼˜ç‚¹**ï¼š
- é€Ÿåº¦æå¿«ï¼ˆO(1)æ—¶é—´å¤æ‚åº¦ï¼‰
- å‡†ç¡®ç‡100%ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
- æ•°æ®åº“ç´¢å¼•æ”¯æŒï¼ŒæŸ¥è¯¢é«˜æ•ˆ

**å±€é™æ€§**ï¼š
- æ— æ³•è¯†åˆ«æªè¾ä¸åŒä½†è¯­ä¹‰ç›¸åŒçš„é¢˜ç›®
- é¢˜ç›®å¤šä¸€ä¸ªæ ‡ç‚¹ç¬¦å·éƒ½ä¼šå¯¼è‡´å“ˆå¸Œä¸åŒ

**ä»£ç å®ç°**ï¼š
```javascript
const crypto = require('crypto');

function calculateContentHash(question) {
    const content = question.content + (question.options ? JSON.stringify(question.options) : '');
    return crypto.createHash('md5').update(content).digest('hex');
}

// æŸ¥è¯¢å·²æœ‰å“ˆå¸Œ
const existingHashes = await db.getExistingQuestionHashes(topic, 30);

// è¿‡æ»¤å·²å­˜åœ¨çš„é¢˜ç›®
const filtered = questions.filter(q => {
    const hash = calculateContentHash(q);
    return !existingHashes.includes(hash);
});
```

### ç¬¬äºŒå±‚ï¼šæ–‡æœ¬ç›¸ä¼¼åº¦ç®—æ³•

**åŸç†**ï¼šç»“åˆJaccardç›¸ä¼¼åº¦å’Œä½™å¼¦ç›¸ä¼¼åº¦ï¼Œè®¡ç®—é¢˜ç›®æ–‡æœ¬çš„ç»¼åˆç›¸ä¼¼åº¦

**ç®—æ³•è¯¦è§£**ï¼š

#### 1. Jaccardç›¸ä¼¼åº¦ï¼ˆåŸºäºè¯é›†åˆï¼‰

```
ç›¸ä¼¼åº¦ = äº¤é›†å¤§å° / å¹¶é›†å¤§å°

ç¤ºä¾‹ï¼š
é¢˜ç›®1: "ä»€ä¹ˆæ˜¯ ReAct æ¨¡å¼"
é¢˜ç›®2: "ReAct æ¨¡å¼ æ˜¯ ä»€ä¹ˆ"

è¯é›†åˆ1: {ä»€ä¹ˆ, æ˜¯, ReAct, æ¨¡å¼}
è¯é›†åˆ2: {ReAct, æ¨¡å¼, æ˜¯, ä»€ä¹ˆ}

äº¤é›†: {ä»€ä¹ˆ, æ˜¯, ReAct, æ¨¡å¼} = 4ä¸ªè¯
å¹¶é›†: {ä»€ä¹ˆ, æ˜¯, ReAct, æ¨¡å¼} = 4ä¸ªè¯

Jaccardç›¸ä¼¼åº¦ = 4/4 = 1.0
```

**ç‰¹ç‚¹**ï¼š
- ä¸è€ƒè™‘è¯åº
- ä¸è€ƒè™‘è¯é¢‘
- é€‚åˆå¿«é€Ÿåˆ¤æ–­æ•´ä½“ç›¸ä¼¼åº¦

#### 2. ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆåŸºäºè¯é¢‘å‘é‡ï¼‰

```
ç›¸ä¼¼åº¦ = (å‘é‡A Â· å‘é‡B) / (||A|| Ã— ||B||)

ç¤ºä¾‹ï¼š
é¢˜ç›®1: "ä»€ä¹ˆ æ˜¯ ReAct ReAct æ¨¡å¼"
é¢˜ç›®2: "ReAct æ¨¡å¼ æ˜¯ ä»€ä¹ˆ çš„"

è¯é¢‘å‘é‡1: {ä»€ä¹ˆ:1, æ˜¯:1, ReAct:2, æ¨¡å¼:1}
è¯é¢‘å‘é‡2: {ä»€ä¹ˆ:1, æ˜¯:1, ReAct:1, æ¨¡å¼:1, çš„:1}

ç‚¹ç§¯ = 1Ã—1 + 1Ã—1 + 2Ã—1 + 1Ã—1 = 5
æ¨¡é•¿A = âˆš(1Â² + 1Â² + 2Â² + 1Â²) = âˆš7 â‰ˆ 2.646
æ¨¡é•¿B = âˆš(1Â² + 1Â² + 1Â² + 1Â² + 1Â²) = âˆš5 â‰ˆ 2.236

ä½™å¼¦ç›¸ä¼¼åº¦ = 5 / (2.646 Ã— 2.236) â‰ˆ 0.845
```

**ç‰¹ç‚¹**ï¼š
- è€ƒè™‘è¯é¢‘
- ä¸è€ƒè™‘è¯åº
- å¯¹æ–‡æ¡£é•¿åº¦ä¸æ•æ„Ÿ

#### 3. ç»¼åˆç›¸ä¼¼åº¦ï¼ˆæ¨èï¼‰

```javascript
ç»¼åˆç›¸ä¼¼åº¦ = Jaccard Ã— 0.4 + ä½™å¼¦ Ã— 0.6

ä¸ºä»€ä¹ˆè¿™æ ·åŠ æƒï¼Ÿ
- Jaccardä¾§é‡æ•´ä½“ç»“æ„ç›¸ä¼¼æ€§ï¼ˆæƒé‡40%ï¼‰
- ä½™å¼¦ä¾§é‡å†…å®¹ç»†èŠ‚ç›¸ä¼¼æ€§ï¼ˆæƒé‡60%ï¼‰
```

**ç›¸ä¼¼åº¦é˜ˆå€¼è®¾ç½®**ï¼š

| ç›¸ä¼¼åº¦èŒƒå›´ | åˆ¤å®š | å¤„ç†ç­–ç•¥ |
|-----------|------|---------|
| â‰¥ 0.75 | é«˜åº¦ç›¸ä¼¼ | ç›´æ¥åˆ¤å®šä¸ºé‡å¤ |
| 0.60-0.75 | ä¸­åº¦ç›¸ä¼¼ | å¯é€‰ï¼šClaudeæœ€ç»ˆåˆ¤æ–­ |
| 0.45-0.60 | ä½åº¦ç›¸ä¼¼ | æ ¹æ®ç­–ç•¥å†³å®š |
| < 0.45 | ä¸ç›¸ä¼¼ | ä¿ç•™ |

**ä»£ç å®ç°**ï¼š
```javascript
const { findSimilarQuestions, combinedSimilarity } = require('./utils/similarity');

// è·å–å·²æœ‰é¢˜ç›®å†…å®¹
const existingQuestions = await db.getExistingQuestionContents(topic, 30);

// æ£€æµ‹ç›¸ä¼¼åº¦
const uniqueQuestions = [];
for (const newQ of newQuestions) {
    const similarQuestions = findSimilarQuestions(newQ, existingQuestions, 0.7);

    if (similarQuestions.length === 0) {
        uniqueQuestions.push(newQ);  // æ— ç›¸ä¼¼é¢˜ç›®
    } else {
        console.log(`æ£€æµ‹åˆ°ç›¸ä¼¼é¢˜ç›® (ç›¸ä¼¼åº¦: ${similarQuestions[0].similarity}):`);
        console.log(`æ–°é¢˜: ${newQ.content}`);
        console.log(`å·²æœ‰: ${similarQuestions[0].question.content}`);

        // æ ¹æ®é‡å¤åº¦ç­–ç•¥å¤„ç†
        if (repeatPolicy === 'avoid') {
            continue;  // å®Œå…¨é¿å…ï¼Œè·³è¿‡
        } else if (repeatPolicy === 'allow_few' && Math.random() < 0.2) {
            uniqueQuestions.push(newQ);  // 20%æ¦‚ç‡ä¿ç•™
        }
    }
}
```

**å®é™…æ•ˆæœç¤ºä¾‹**ï¼š

```
æ–°é¢˜ç›®: "åœ¨AI Agentå¼€å‘ä¸­ï¼ŒReActæ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»€ä¹ˆï¼Ÿ"
å·²æœ‰é¢˜ç›®: "ä»€ä¹ˆæ˜¯AI Agentä¸­çš„ReActï¼ˆæ¨ç†ä¸è¡ŒåŠ¨ï¼‰æ¨¡å¼ï¼Ÿ"

Jaccardç›¸ä¼¼åº¦: 0.625 (è¯é›†åˆæœ‰è¾ƒå¤§é‡å )
ä½™å¼¦ç›¸ä¼¼åº¦: 0.742 (è€ƒè™‘è¯é¢‘åæ›´ç²¾ç¡®)
ç»¼åˆç›¸ä¼¼åº¦: 0.695 (0.625Ã—0.4 + 0.742Ã—0.6)

åˆ¤å®š: ä¸­åº¦ç›¸ä¼¼ï¼Œå¯èƒ½æ˜¯é‡å¤é¢˜ç›®
```

### ç¬¬ä¸‰å±‚ï¼šClaudeè¯­ä¹‰åˆ¤æ–­ï¼ˆå¯é€‰ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç›¸ä¼¼åº¦åœ¨0.60-0.75ä¹‹é—´çš„è¾¹ç•Œæƒ…å†µ
- éœ€è¦æœ€ç»ˆç¡®è®¤æ˜¯å¦ä¸ºé‡å¤é¢˜ç›®

**ä¼˜ç‚¹**ï¼š
- ç†è§£è¯­ä¹‰ï¼Œä¸å±€é™äºè¯æ±‡åŒ¹é…
- å‡†ç¡®ç‡æœ€é«˜ï¼ˆ95-99%ï¼‰
- å¯è¯†åˆ«åŒä¹‰æ›¿æ¢ã€å¥å¼å˜æ¢

**ç¼ºç‚¹**ï¼š
- éœ€è¦è°ƒç”¨APIï¼Œé€Ÿåº¦æ…¢
- æœ‰æˆæœ¬ï¼ˆæ¯æ¬¡åˆ¤æ–­æ¶ˆè€—tokensï¼‰

**ä»£ç å®ç°**ï¼š
```javascript
async function isSimilarByClaude(question1, question2) {
    const prompt = `
è¯·åˆ¤æ–­ä»¥ä¸‹ä¸¤é“é¢˜ç›®æ˜¯å¦æœ¬è´¨ç›¸åŒï¼ˆåªæ˜¯æªè¾ä¸åŒï¼‰ï¼š

é¢˜ç›®1ï¼š${question1.content}
${question1.options ? `é€‰é¡¹1ï¼š${JSON.stringify(question1.options)}` : ''}

é¢˜ç›®2ï¼š${question2.content}
${question2.options ? `é€‰é¡¹2ï¼š${JSON.stringify(question2.options)}` : ''}

åªå›ç­”ï¼šç›¸åŒ æˆ– ä¸åŒ
    `;

    const result = await callClaude(prompt);
    return result.includes('ç›¸åŒ');
}

// ä½¿ç”¨ç¤ºä¾‹
if (similarity >= 0.60 && similarity < 0.75) {
    const isSimilar = await isSimilarByClaude(newQuestion, existingQuestion);
    if (isSimilar && repeatPolicy === 'avoid') {
        continue;  // Claudeç¡®è®¤ç›¸åŒï¼Œè·³è¿‡
    }
}
```

## é‡å¤åº¦æ§åˆ¶ç­–ç•¥

### ç­–ç•¥1: `avoid` - å®Œå…¨é¿å…é‡å¤

**é€‚ç”¨åœºæ™¯**ï¼šç”¨æˆ·æƒ³è¦å…¨æ–°çš„é¢˜ç›®ï¼Œå¤ä¹ ä¸åŒçŸ¥è¯†ç‚¹

**å·¥ä½œæµç¨‹**ï¼š
1. ç¬¬ä¸€å±‚ï¼šå“ˆå¸Œç²¾ç¡®åŒ¹é… âœ“
2. ç¬¬äºŒå±‚ï¼šæ–‡æœ¬ç›¸ä¼¼åº¦ï¼ˆé˜ˆå€¼0.7ï¼‰âœ“
3. ç¬¬ä¸‰å±‚ï¼ˆå¯é€‰ï¼‰ï¼šClaudeè¯­ä¹‰åˆ¤æ–­ï¼ˆ0.6-0.75èŒƒå›´ï¼‰âœ“

**ç»“æœ**ï¼šåªä¿ç•™å®Œå…¨ä¸åŒçš„é¢˜ç›®

### ç­–ç•¥2: `allow_few` - å…è®¸å°‘é‡é‡å¤ï¼ˆ10-20%ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç”¨æˆ·æƒ³å·©å›ºè®°å¿†ï¼Œé€‚å½“é‡å¤æœ‰åŠ©äºå­¦ä¹ 

**å·¥ä½œæµç¨‹**ï¼š
1. ç¬¬ä¸€å±‚ï¼šå“ˆå¸Œç²¾ç¡®åŒ¹é… âœ“
2. ç¬¬äºŒå±‚ï¼šæ–‡æœ¬ç›¸ä¼¼åº¦æ£€æµ‹ï¼Œç›¸ä¼¼é¢˜ç›®20%æ¦‚ç‡ä¿ç•™
3. ç¬¬ä¸‰å±‚ï¼šä¸ä½¿ç”¨ï¼ˆå…è®¸ä¸€å®šè¯¯å·®ï¼‰

**ç»“æœ**ï¼š10-20%é¢˜ç›®å¯èƒ½é‡å¤ï¼Œæœ‰åŠ©äºå¼ºåŒ–è®°å¿†

### ç­–ç•¥3: `unlimited` - ä¸é™åˆ¶é‡å¤

**é€‚ç”¨åœºæ™¯**ï¼šé¢˜åº“è¾ƒå°ï¼Œæˆ–ç”¨æˆ·ä¸åœ¨æ„é‡å¤

**å·¥ä½œæµç¨‹**ï¼š
1. ç¬¬ä¸€å±‚ï¼šå“ˆå¸Œç²¾ç¡®åŒ¹é… âœ“ï¼ˆåªè¿‡æ»¤å®Œå…¨ç›¸åŒï¼‰
2. ç¬¬äºŒå±‚ï¼šä¸ä½¿ç”¨
3. ç¬¬ä¸‰å±‚ï¼šä¸ä½¿ç”¨

**ç»“æœ**ï¼šå¯èƒ½åŒ…å«ç›¸ä¼¼é¢˜ç›®

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•

```sql
CREATE INDEX IF NOT EXISTS idx_questions_content_hash ON questions(content_hash);
CREATE INDEX IF NOT EXISTS idx_quizzes_created_at ON quizzes(created_at);
```

### æ‰¹é‡æŸ¥è¯¢

```javascript
// âŒ ä¸å¥½ï¼šæ¯é“é¢˜å•ç‹¬æŸ¥è¯¢
for (const q of questions) {
    const exists = await db.checkQuestionExists(q);
}

// âœ… å¥½ï¼šæ‰¹é‡æŸ¥è¯¢ä¸€æ¬¡
const existingHashes = await db.getExistingQuestionHashes(topic, 30);
const existingContents = await db.getExistingQuestionContents(topic, 30);

// æœ¬åœ°å†…å­˜ä¸­è¿‡æ»¤
const filtered = questions.filter(q => !isDuplicate(q, existingHashes, existingContents));
```

### ç›¸ä¼¼åº¦è®¡ç®—ç¼“å­˜

```javascript
const similarityCache = new Map();

function getCachedSimilarity(q1, q2) {
    const key = `${q1.content.substring(0, 50)}|${q2.content.substring(0, 50)}`;

    if (similarityCache.has(key)) {
        return similarityCache.get(key);
    }

    const similarity = combinedSimilarity(q1.content, q2.content);
    similarityCache.set(key, similarity);
    return similarity;
}
```

## æ€»ç»“

### æ¨èé…ç½®

**é«˜ç²¾åº¦åœºæ™¯**ï¼ˆå®Œå…¨é¿å…é‡å¤ï¼‰ï¼š
```javascript
{
    repeatPolicy: 'avoid',
    layers: [1, 2, 3],  // ä½¿ç”¨æ‰€æœ‰ä¸‰å±‚
    thresholds: {
        layer2: 0.7,  // ç¬¬äºŒå±‚é˜ˆå€¼
        layer3Range: [0.6, 0.75]  // ç¬¬ä¸‰å±‚åˆ¤æ–­èŒƒå›´
    }
}
```

**å¹³è¡¡åœºæ™¯**ï¼ˆå…è®¸å°‘é‡é‡å¤ï¼Œæ€§èƒ½å¥½ï¼‰ï¼š
```javascript
{
    repeatPolicy: 'allow_few',
    layers: [1, 2],  // ä¸ä½¿ç”¨Claudeåˆ¤æ–­
    thresholds: {
        layer2: 0.7,
        allowRate: 0.2  // 20%æ¦‚ç‡ä¿ç•™ç›¸ä¼¼é¢˜ç›®
    }
}
```

**æ€§èƒ½ä¼˜å…ˆåœºæ™¯**ï¼ˆå¿«é€Ÿç”Ÿæˆï¼‰ï¼š
```javascript
{
    repeatPolicy: 'unlimited',
    layers: [1],  // åªç”¨å“ˆå¸Œç²¾ç¡®åŒ¹é…
    thresholds: {}
}
```

### ä¼˜åŠ¿æ€»ç»“

1. âœ… **ç²¾ç¡®åŒ¹é…**ï¼šå“ˆå¸Œå®Œå…¨è§£å†³ç›¸åŒé¢˜ç›®é—®é¢˜
2. âœ… **è¯­ä¹‰è¯†åˆ«**ï¼šç›¸ä¼¼åº¦ç®—æ³•è§£å†³æªè¾ä¸åŒé—®é¢˜
3. âœ… **æ™ºèƒ½åˆ¤æ–­**ï¼šClaudeæœ€ç»ˆç¡®è®¤è¾¹ç•Œæƒ…å†µ
4. âœ… **çµæ´»æ§åˆ¶**ï¼šä¸‰ç§ç­–ç•¥é€‚åº”ä¸åŒéœ€æ±‚
5. âœ… **é«˜æ€§èƒ½**ï¼šåˆ†å±‚è¿‡æ»¤ï¼Œå‡å°‘ä¸å¿…è¦è®¡ç®—
